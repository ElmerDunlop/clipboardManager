# 应用界面和工作流程 (App UI and Workflow)

## 主界面布局 (Main Screen Layout)

```
┌─────────────────────────────────────────┐
│  剪贴板管理器                            │  ← 标题
├─────────────────────────────────────────┤
│                                          │
│  剪贴板历史                              │  ← 标题文本
│  监听中... / 未监听                       │  ← 状态指示
│                                          │
│  ┌──────────┐  ┌──────────┐            │
│  │开始监听  │  │清空历史  │            │  ← 功能按钮
│  │/停止监听 │  │          │            │
│  └──────────┘  └──────────┘            │
│                                          │
│  ┌────────────────────────────────┐    │
│  │ Hello World                     │    │  ← 剪贴板条目
│  │ 2024-01-29 13:00:00            │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌────────────────────────────────┐    │
│  │ https://example.com             │    │
│  │ 2024-01-29 12:55:30            │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌────────────────────────────────┐    │
│  │ Sample clipboard text...        │    │
│  │ 2024-01-29 12:30:15            │    │
│  └────────────────────────────────┘    │
│                                          │
└─────────────────────────────────────────┘
```

## 用户交互流程 (User Interaction Flow)

### 1. 启动监听

```
用户操作              系统响应
───────              ────────
点击"开始监听"
    │
    ├──────────────► 启动 ClipboardMonitorService
    │
    ├──────────────► 保存状态到 SharedPreferences
    │
    ├──────────────► 更新按钮文字为"停止监听"
    │
    └──────────────► 显示 Toast "监听中..."
```

### 2. 复制文本到剪贴板

```
用户在其他应用    →    系统剪贴板    →    本应用
──────────────         ──────────         ──────

复制文本
    │
    └─────────────────► 剪贴板变化
                            │
                            └────────────► ClipboardMonitorService 监听到
                                               │
                                               ├─ 提取文本内容
                                               │
                                               ├─ 检查是否重复
                                               │
                                               ├─ 保存到数据库
                                               │
                                               └─ LiveData 自动通知 UI
                                                      │
                                                      └─ RecyclerView 更新显示
```

### 3. 从历史复制

```
用户操作              系统响应
───────              ────────
点击历史条目
    │
    ├──────────────► 获取条目内容
    │
    ├──────────────► 创建 ClipData
    │
    ├──────────────► 设置到系统剪贴板
    │
    └──────────────► 显示 Toast "复制"
```

### 4. 删除历史条目

```
用户操作              系统响应
───────              ────────
长按历史条目
    │
    ├──────────────► 显示确认对话框
    │                   │
    │                   ├─ "确定要删除这条记录吗？"
    │                   └─ [删除] [取消]
    │
点击"删除"
    │
    ├──────────────► ViewModel.delete(entry)
    │
    ├──────────────► Repository.delete()
    │
    ├──────────────► 数据库删除记录
    │
    ├──────────────► LiveData 更新
    │
    ├──────────────► UI 自动刷新
    │
    └──────────────► 显示 Toast "已删除"
```

### 5. 清空历史

```
用户操作              系统响应
───────              ────────
点击"清空历史"
    │
    ├──────────────► 显示确认对话框
    │                   │
    │                   ├─ "确定要清空所有历史记录吗？"
    │                   └─ [清空历史] [取消]
    │
点击"清空历史"
    │
    ├──────────────► ViewModel.deleteAll()
    │
    ├──────────────► Repository.deleteAll()
    │
    ├──────────────► 数据库清空所有记录
    │
    ├──────────────► LiveData 更新
    │
    ├──────────────► UI 显示空状态
    │
    └──────────────► 显示 Toast "已清空历史"
```

## 空状态显示 (Empty State)

```
┌─────────────────────────────────────────┐
│  剪贴板管理器                            │
├─────────────────────────────────────────┤
│                                          │
│  剪贴板历史                              │
│  未监听                                  │
│                                          │
│  ┌──────────┐  ┌──────────┐            │
│  │开始监听  │  │清空历史  │            │
│  └──────────┘  └──────────┘            │
│                                          │
│                                          │
│           暂无剪贴板数据                 │  ← 空状态提示
│                                          │
│                                          │
│                                          │
└─────────────────────────────────────────┘
```

## 生命周期管理 (Lifecycle Management)

### Activity 生命周期
```
onCreate()
    │
    ├─ 初始化 ViewBinding
    ├─ 获取 ViewModel
    ├─ 从 SharedPreferences 恢复监听状态
    ├─ 设置 RecyclerView
    ├─ 设置按钮监听器
    └─ 观察 LiveData
         │
         └─ 数据变化时自动更新 UI
```

### Service 生命周期
```
onCreate()
    │
    ├─ 获取 ClipboardManager
    ├─ 初始化 Database
    └─ 创建 Repository

onStartCommand()
    │
    └─ 添加剪贴板监听器

onDestroy()
    │
    ├─ 移除剪贴板监听器
    └─ 取消 CoroutineScope（防止内存泄漏）
```

## 数据流向图 (Data Flow)

```
┌─────────────┐
│   用户操作   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         MainActivity (View)              │
│  • 显示UI                                │
│  • 处理用户输入                          │
└──────┬──────────────────────────────────┘
       │ observe LiveData
       ▼
┌─────────────────────────────────────────┐
│    ClipboardViewModel (ViewModel)        │
│  • 管理 UI 数据                          │
│  • 协调 Repository                       │
└──────┬──────────────────────────────────┘
       │ CRUD operations
       ▼
┌─────────────────────────────────────────┐
│   ClipboardRepository (Repository)       │
│  • 数据访问抽象                          │
│  • 去重逻辑                              │
└──────┬──────────────────────────────────┘
       │ DAO methods
       ▼
┌─────────────────────────────────────────┐
│     ClipboardDao (DAO Interface)         │
│  • 定义数据库操作                        │
└──────┬──────────────────────────────────┘
       │ SQL queries
       ▼
┌─────────────────────────────────────────┐
│    ClipboardDatabase (Room DB)           │
│  • SQLite 数据库                         │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│       Local Storage (SQLite)             │
│  • /data/data/com.clipboard.manager/    │
│    databases/clipboard_database          │
└─────────────────────────────────────────┘
```

## 关键特性说明

### 🔄 自动更新机制
- 使用 LiveData 实现数据观察
- 数据变化自动触发 UI 更新
- 无需手动刷新界面

### 💾 数据持久化
- Room 数据库自动保存所有数据
- SharedPreferences 保存监听状态
- 应用重启后数据和状态保持

### ⚡ 异步处理
- 所有数据库操作使用 Kotlin 协程
- 在 IO 线程执行，不阻塞主线程
- UI 操作始终在主线程

### 🛡️ 内存安全
- Service 销毁时取消协程作用域
- 正确处理 Activity 生命周期
- 使用 ViewModel 避免内存泄漏

### ✨ 用户体验
- Material Design 设计
- 即时的操作反馈
- 清晰的状态指示
- 平滑的动画效果（DiffUtil）
